<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Congrats Mommy!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Indie+Flower&family=Patrick+Hand&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0; padding: 0; overflow: hidden; background-color: #333;
            touch-action: none; -webkit-user-select: none; user-select: none;
        }
        #card-container {
            position: relative; width: 100vw; height: 100vh; background-color: #fdf6e3;
            background-image: radial-gradient(#d4c5a3 1px, transparent 1px), linear-gradient(to bottom, #fdf6e3 0%, #f4e9c8 100%);
            background-size: 20px 20px, 100% 100%; overflow: hidden; font-family: 'Indie Flower', cursive;
        }
        .paper-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; opacity: 0.4;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.5'/%3E%3C/svg%3E");
            z-index: 5;
        }
        @keyframes wiggle { 0%, 100% { transform: rotate(-3deg); } 50% { transform: rotate(3deg); } }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }
        @keyframes popIn { 0% { transform: scale(0); } 70% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .animate-wiggle { animation: wiggle 2s ease-in-out infinite; }
        .animate-float { animation: float 3s ease-in-out infinite; }
        .letter { display: inline-block; transition: transform 0.2s; cursor: pointer; }
        .letter:hover { transform: scale(1.3) rotate(10deg) !important; color: #ff5e5e; }
        #drawing-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 20; touch-action: none; }
        .character { transition: transform 0.2s; cursor: pointer; filter: drop-shadow(2px 4px 0px rgba(0,0,0,0.1)); }
        .character:active { transform: scale(0.9) translateY(5px); }
        .ui-wrapper {
            position: absolute; bottom: 1.5rem; left: 0; width: 100%; display: flex; flex-direction: column; align-items: center; z-index: 50; pointer-events: none;
        }
        .control-panel {
            pointer-events: auto; background: rgba(255, 255, 255, 0.95); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border-radius: 20px; padding: 0.5rem 1rem; border: 2px solid #e5e7eb; display: flex; align-items: center; gap: 0.5rem;
        }
        @media (max-width: 768px) {
            .control-panel { flex-wrap: wrap; justify-content: center; width: 95%; gap: 0.5rem; padding: 0.8rem; }
            .ui-wrapper { bottom: 1rem; }
        }
        .tool-btn {
            width: 44px; height: 44px; border-radius: 50%; border: 2px solid transparent; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; background: #f3f4f6; cursor: pointer; transition: transform 0.1s;
        }
        .tool-btn.active { background: #dbeafe; border-color: #3b82f6; transform: scale(1.1); }
        .color-btn {
            width: 36px; height: 36px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 0 2px #e5e7eb; transition: transform 0.1s; cursor: pointer;
        }
        .color-btn.active { transform: scale(1.2); box-shadow: 0 0 0 2px #3b82f6; }
        #sticker-palette {
            pointer-events: auto; position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: white; padding: 10px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: none; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 12px; border: 2px solid #e5e7eb;
        }
        #sticker-palette.show { display: grid; animation: popIn 0.2s ease-out; }
        .sticker-option { font-size: 2rem; cursor: pointer; padding: 5px; border-radius: 8px; }
        .sticker-option.selected { background-color: #dbeafe; border: 1px solid #3b82f6; }
        #character-palette {
            pointer-events: auto; position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: white; padding: 10px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: none; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px; border: 2px solid #e5e7eb;
        }
        #character-palette.show { display: grid; animation: popIn 0.2s ease-out; }
        .char-stamp-option { cursor: pointer; padding: 8px; border-radius: 8px; text-align: center; transition: transform 0.1s; }
        .char-stamp-option:hover { transform: scale(1.1); }
        .char-stamp-option.selected { background-color: #dbeafe; border: 2px solid #3b82f6; }
        #visibility-palette {
            pointer-events: auto; position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: white; padding: 10px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: none; flex-direction: column; gap: 8px; margin-bottom: 12px; border: 2px solid #e5e7eb; min-width: 140px;
        }
        #visibility-palette.show { display: flex; animation: popIn 0.2s ease-out; }
        .visibility-toggle { display: flex; align-items: center; gap: 8px; padding: 6px 10px; border-radius: 8px; cursor: pointer; transition: background 0.1s; }
        .visibility-toggle:hover { background: #f3f4f6; }
        .visibility-toggle input { width: 18px; height: 18px; cursor: pointer; }
        .visibility-toggle.hidden { opacity: 0.5; }
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100; display: none; align-items: center; justify-content: center; backdrop-filter: blur(3px); padding: 20px;
        }
        .modal-box {
            background: white; padding: 1.5rem; border-radius: 1rem; width: 100%; max-width: 400px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2); font-family: 'Patrick Hand', cursive; animation: popIn 0.2s ease-out;
        }
        .saved-item { display: flex; justify-content: space-between; align-items: center; padding: 0.8rem; border-bottom: 1px solid #eee; cursor: pointer; }
        .saved-item:active { background: #f0f9ff; }
        #flash { position: fixed; inset: 0; background: white; z-index: 200; opacity: 0; pointer-events: none; transition: opacity 0.5s; }
    </style>
</head>
<body>
    <div id="flash"></div>


    <!-- 0. CARD TEMPLATE SELECTOR MODAL -->
    <div id="template-modal" class="modal-overlay">
        <div class="modal-box" style="max-width: 500px;">
            <h2 class="text-3xl font-bold mb-4 text-indigo-600">Choose a Card</h2>
            <div id="template-list" class="grid grid-cols-2 gap-3 mb-4">
                <div class="template-option p-4 border-2 border-pink-300 bg-pink-50 rounded-xl cursor-pointer hover:scale-105 transition-transform" onclick="selectTemplate('mommy')">
                    <div class="text-3xl mb-2">üë©‚Äçüíº</div>
                    <div class="font-bold text-pink-600">Congrats Mommy!</div>
                    <div class="text-sm text-gray-500">New job celebration</div>
                </div>
                <div class="template-option p-4 border-2 border-purple-300 bg-purple-50 rounded-xl cursor-pointer hover:scale-105 transition-transform" onclick="selectTemplate('birthday')">
                    <div class="text-3xl mb-2">üéÇ</div>
                    <div class="font-bold text-purple-600">Happy Birthday!</div>
                    <div class="text-sm text-gray-500">Birthday wishes</div>
                </div>
                <div class="template-option p-4 border-2 border-green-300 bg-green-50 rounded-xl cursor-pointer hover:scale-105 transition-transform" onclick="selectTemplate('thankyou')">
                    <div class="text-3xl mb-2">üôè</div>
                    <div class="font-bold text-green-600">Thank You!</div>
                    <div class="text-sm text-gray-500">Show appreciation</div>
                </div>
                <div class="template-option p-4 border-2 border-blue-300 bg-blue-50 rounded-xl cursor-pointer hover:scale-105 transition-transform" onclick="selectTemplate('getwell')">
                    <div class="text-3xl mb-2">üíê</div>
                    <div class="font-bold text-blue-600">Get Well Soon!</div>
                    <div class="text-sm text-gray-500">Healing wishes</div>
                </div>
                <div class="template-option p-4 border-2 border-yellow-300 bg-yellow-50 rounded-xl cursor-pointer hover:scale-105 transition-transform" onclick="selectTemplate('congrats')">
                    <div class="text-3xl mb-2">üéâ</div>
                    <div class="font-bold text-yellow-600">Congratulations!</div>
                    <div class="text-sm text-gray-500">General celebration</div>
                </div>
                <div class="template-option p-4 border-2 border-red-300 bg-red-50 rounded-xl cursor-pointer hover:scale-105 transition-transform" onclick="selectTemplate('love')">
                    <div class="text-3xl mb-2">‚ù§Ô∏è</div>
                    <div class="font-bold text-red-600">I Love You!</div>
                    <div class="text-sm text-gray-500">Express your love</div>
                </div>
            </div>
            <div class="flex justify-end"><button onclick="closeModals()" class="px-6 py-2 bg-gray-200 rounded-full font-bold text-lg">Close</button></div>
        </div>
    </div>

    <!-- 1. GALLERY MODAL -->
    <div id="gallery-modal" class="modal-overlay">
        <div class="modal-box">
            <h2 class="text-3xl font-bold mb-4 text-indigo-600">Saved Drawings</h2>
            <div id="gallery-list" class="max-h-60 overflow-y-auto mb-4 border rounded p-2 bg-gray-50"></div>
            
            <!-- BACKUP SECTION -->
            <div class="mb-4 pt-2 border-t border-gray-100">
                <p class="text-sm text-gray-500 mb-2">Backup / Transfer:</p>
                <div class="flex gap-2 text-sm">
                    <button onclick="exportData()" class="text-blue-600 underline hover:text-blue-800">Export File</button>
                    <span class="text-gray-300">|</span>
                    <button onclick="document.getElementById('import-input').click()" class="text-blue-600 underline hover:text-blue-800">Import File</button>
                    <input type="file" id="import-input" style="display:none" accept=".json" onchange="importData(this)">
                </div>
            </div>


            <div class="flex justify-end"><button onclick="closeModals()" class="px-6 py-2 bg-gray-200 rounded-full font-bold text-lg">Close</button></div>
        </div>
    </div>


    <!-- 2. SAVE NAME MODAL -->
    <div id="save-modal" class="modal-overlay">
        <div class="modal-box">
            <h2 class="text-2xl font-bold mb-2">Name your drawing:</h2>
            <input type="text" id="drawing-name-input" class="w-full border-2 border-blue-300 rounded-lg p-3 text-xl mb-4 focus:outline-none focus:border-blue-500" placeholder="e.g. Emma's Art">
            <div class="flex justify-end gap-3"><button onclick="closeModals()" class="px-4 py-2 text-gray-500 text-lg">Cancel</button><button onclick="finalizeSave()" class="px-6 py-2 bg-blue-500 text-white rounded-full font-bold text-lg shadow-lg">Save</button></div>
        </div>
    </div>


    <!-- 3. IMAGE DOWNLOAD MODAL (Android Optimized) -->
    <div id="image-modal" class="modal-overlay">
        <div class="modal-box flex flex-col items-center">
            <h2 class="text-2xl font-bold mb-2 text-center">Ready to Save!</h2>
            <p class="text-center text-gray-500 mb-4 text-sm">Tap "Download" or long-press the image to save.</p>
            <div id="img-result-container" class="border-4 border-white shadow-lg mb-4 max-h-[50vh] overflow-hidden"></div>
            <!-- Hidden link for Android auto-download -->
            <a id="download-link" style="display:none"></a>
            <div class="flex gap-2 w-full">
                <button onclick="triggerDownload()" class="flex-1 px-4 py-3 bg-green-500 hover:bg-green-600 text-white rounded-lg font-bold text-lg shadow">Download ‚¨áÔ∏è</button>
                <button onclick="closeModals()" class="px-4 py-3 bg-gray-200 text-gray-700 rounded-lg font-bold text-lg">Close</button>
            </div>
        </div>
    </div>

    <!-- 4. VIDEO DOWNLOAD MODAL (Choose format) -->
    <div id="video-modal" class="modal-overlay">
        <div class="modal-box flex flex-col items-center">
            <h2 class="text-2xl font-bold mb-2 text-center">üé¨ Recording Complete!</h2>
            <p class="text-center text-gray-500 mb-4 text-sm">Choose your download format:</p>
            <div class="flex flex-col gap-3 w-full">
                <button onclick="downloadAsVideo()" class="px-6 py-4 bg-red-500 hover:bg-red-600 text-white rounded-lg font-bold text-lg shadow-lg flex items-center justify-center gap-2">
                    <span>üìπ</span>
                    <span>Download as Video (.webm)</span>
                </button>
                <button id="gif-download-btn" onclick="downloadAsGif()" class="px-6 py-4 bg-purple-500 hover:bg-purple-600 text-white rounded-lg font-bold text-lg shadow-lg flex items-center justify-center gap-2">
                    <span>üéûÔ∏è</span>
                    <span>Download as GIF</span>
                </button>
                <button onclick="closeModals()" class="px-4 py-3 bg-gray-200 text-gray-700 rounded-lg font-bold text-lg">Close</button>
            </div>
        </div>
    </div>


    <div id="card-container">
        <div class="paper-overlay"></div>
        <svg style="position: absolute; width: 0; height: 0;"><defs><filter id="rough-paper"><feTurbulence type="fractalNoise" baseFrequency="0.04" numOctaves="5" result="noise" /><feDisplacementMap in="SourceGraphic" in2="noise" scale="2" /></filter></defs></svg>
        <div class="absolute inset-0 z-10 flex flex-col items-center justify-center pointer-events-none">
            <div class="text-center mb-8 pointer-events-auto">
                <h1 class="text-6xl md:text-8xl font-bold tracking-wider mb-2" id="main-title"></h1>
                <p id="subtitle-text" class="text-2xl md:text-4xl text-gray-600 font-['Patrick_Hand'] animate-float mt-4 bg-white/50 px-4 py-2 rounded-lg inline-block transform -rotate-2">We are so proud of your new job!</p>
            </div>
            <div id="characters-container" class="relative w-full max-w-4xl h-96 flex items-end justify-center space-x-4 md:space-x-12 pointer-events-auto pb-12">
                <div class="character group relative w-32 h-48" onclick="characterJump(this)"><div class="absolute -top-12 opacity-0 group-hover:opacity-100 transition-opacity text-xl font-bold text-pink-500 w-full text-center">YAY!</div><svg viewBox="0 0 100 150" class="w-full h-full overflow-visible"><circle cx="50" cy="30" r="20" fill="none" stroke="#000" stroke-width="3" filter="url(#rough-paper)"/><path d="M25 30 Q 15 20, 25 10 Q 35 0, 50 5 Q 65 0, 75 10 Q 85 20, 75 30" fill="none" stroke="#8B4513" stroke-width="3" filter="url(#rough-paper)"/><circle cx="43" cy="28" r="2" fill="#000"/><circle cx="57" cy="28" r="2" fill="#000"/><path d="M40 38 Q 50 45, 60 38" fill="none" stroke="#000" stroke-width="2"/><path d="M50 50 L 25 120 L 75 120 Z" fill="#FFB6C1" stroke="#000" stroke-width="3" filter="url(#rough-paper)"/><path d="M40 60 L 10 40" fill="none" stroke="#000" stroke-width="3" class="origin-bottom-right animate-wiggle"/><path d="M60 60 L 90 40" fill="none" stroke="#000" stroke-width="3" class="origin-bottom-left animate-wiggle" style="animation-delay: 0.5s"/><path d="M40 120 L 35 145" fill="none" stroke="#000" stroke-width="3"/><path d="M60 120 L 65 145" fill="none" stroke="#000" stroke-width="3"/></svg></div>
                <div class="character group relative w-40 h-64" onclick="characterJump(this)"><div class="absolute -top-12 opacity-0 group-hover:opacity-100 transition-opacity text-2xl font-bold text-purple-600 w-full text-center">HIRED!</div><svg viewBox="0 0 100 200" class="w-full h-full overflow-visible"><circle cx="50" cy="35" r="25" fill="none" stroke="#000" stroke-width="3" filter="url(#rough-paper)"/><path d="M20 35 C 10 10, 40 0, 50 5 C 60 0, 90 10, 80 35 L 85 80 L 15 80 Z" fill="#333" fill-opacity="0.1" stroke="#333" stroke-width="3" filter="url(#rough-paper)"/><g stroke="#000" stroke-width="2" fill="none"><circle cx="40" cy="35" r="8"/><circle cx="60" cy="35" r="8"/><line x1="48" y1="35" x2="52" y2="35"/><line x1="32" y1="35" x2="25" y2="32"/><line x1="68" y1="35" x2="75" y2="32"/></g><path d="M38 48 Q 50 55, 62 48" fill="none" stroke="#000" stroke-width="2"/><path d="M50 60 L 25 150 L 75 150 Z" fill="#E6E6FA" stroke="#000" stroke-width="3" filter="url(#rough-paper)"/><line x1="45" y1="75" x2="55" y2="75" stroke="#000" stroke-width="2"/><line x1="40" y1="90" x2="60" y2="90" stroke="#000" stroke-width="2"/><path d="M40 70 L 10 90" fill="none" stroke="#000" stroke-width="3"/><path d="M60 70 L 90 90" fill="none" stroke="#000" stroke-width="3"/><path d="M40 150 L 40 190" fill="none" stroke="#000" stroke-width="3"/><path d="M60 150 L 60 190" fill="none" stroke="#000" stroke-width="3"/></svg></div>
                <div class="character group relative w-32 h-48" onclick="characterJump(this)"><div class="absolute -top-12 opacity-0 group-hover:opacity-100 transition-opacity text-xl font-bold text-blue-500 w-full text-center">WOOHOO!</div><svg viewBox="0 0 100 150" class="w-full h-full overflow-visible"><circle cx="50" cy="30" r="20" fill="none" stroke="#000" stroke-width="3" filter="url(#rough-paper)"/><path d="M30 10 L 15 60 M 70 10 L 85 60 M 30 10 Q 50 -5, 70 10" fill="none" stroke="#5D4037" stroke-width="3" filter="url(#rough-paper)"/><circle cx="43" cy="28" r="2" fill="#000"/><circle cx="57" cy="28" r="2" fill="#000"/><path d="M40 38 Q 50 45, 60 38" fill="none" stroke="#000" stroke-width="2"/><path d="M50 50 L 25 120 L 75 120 Z" fill="#87CEEB" stroke="#000" stroke-width="3" filter="url(#rough-paper)"/><path d="M40 60 L 15 20" fill="none" stroke="#000" stroke-width="3" class="origin-bottom-right animate-wiggle"/><path d="M60 60 L 85 20" fill="none" stroke="#000" stroke-width="3" class="origin-bottom-left animate-wiggle" style="animation-delay: 0.3s"/><path d="M40 120 L 35 145" fill="none" stroke="#000" stroke-width="3"/><path d="M60 120 L 65 145" fill="none" stroke="#000" stroke-width="3"/></svg></div>
            </div>
            <div id="hint-text" class="text-xl text-gray-400 font-['Patrick_Hand'] mt-8 pointer-events-auto">(Draw anywhere!)</div>
        </div>
        <canvas id="drawing-canvas"></canvas>
    </div>


    <div class="ui-wrapper">
        <div id="sticker-palette">
            <div class="sticker-option" onclick="selectSticker('‚ù§Ô∏è')">‚ù§Ô∏è</div><div class="sticker-option" onclick="selectSticker('üíñ')">üíñ</div><div class="sticker-option" onclick="selectSticker('ü¶ã')">ü¶ã</div><div class="sticker-option" onclick="selectSticker('üå∏')">üå∏</div><div class="sticker-option" onclick="selectSticker('üå∑')">üå∑</div><div class="sticker-option" onclick="selectSticker('‚≠ê')">‚≠ê</div><div class="sticker-option" onclick="selectSticker('üåà')">üåà</div><div class="sticker-option" onclick="selectSticker('ü¶Ñ')">ü¶Ñ</div><div class="sticker-option" onclick="selectSticker('üëë')">üëë</div><div class="sticker-option" onclick="selectSticker('üéà')">üéà</div>
        </div>
        <div id="character-palette">
            <div class="char-stamp-option" onclick="selectCharacterStamp('girl1')" title="Ella">
                <svg viewBox="0 0 100 150" width="50" height="75"><circle cx="50" cy="30" r="20" fill="none" stroke="#000" stroke-width="3"/><path d="M25 30 Q 15 20, 25 10 Q 35 0, 50 5 Q 65 0, 75 10 Q 85 20, 75 30" fill="none" stroke="#8B4513" stroke-width="3"/><circle cx="43" cy="28" r="2" fill="#000"/><circle cx="57" cy="28" r="2" fill="#000"/><path d="M40 38 Q 50 45, 60 38" fill="none" stroke="#000" stroke-width="2"/><path d="M50 50 L 25 120 L 75 120 Z" fill="#FFB6C1" stroke="#000" stroke-width="3"/><path d="M40 60 L 10 40" fill="none" stroke="#000" stroke-width="3"/><path d="M60 60 L 90 40" fill="none" stroke="#000" stroke-width="3"/><path d="M40 120 L 35 145" fill="none" stroke="#000" stroke-width="3"/><path d="M60 120 L 65 145" fill="none" stroke="#000" stroke-width="3"/></svg>
                <div class="text-xs font-bold text-pink-500">Ella</div>
            </div>
            <div class="char-stamp-option" onclick="selectCharacterStamp('mommy')" title="Mommy">
                <svg viewBox="0 0 100 200" width="50" height="80"><circle cx="50" cy="35" r="25" fill="none" stroke="#000" stroke-width="3"/><path d="M20 35 C 10 10, 40 0, 50 5 C 60 0, 90 10, 80 35" fill="none" stroke="#333" stroke-width="3"/><circle cx="40" cy="33" r="3" fill="#000"/><circle cx="60" cy="33" r="3" fill="#000"/><path d="M38 48 Q 50 55, 62 48" fill="none" stroke="#000" stroke-width="2"/><path d="M50 60 L 25 150 L 75 150 Z" fill="#E6E6FA" stroke="#000" stroke-width="3"/><path d="M40 70 L 10 90" fill="none" stroke="#000" stroke-width="3"/><path d="M60 70 L 90 90" fill="none" stroke="#000" stroke-width="3"/><path d="M40 150 L 40 190" fill="none" stroke="#000" stroke-width="3"/><path d="M60 150 L 60 190" fill="none" stroke="#000" stroke-width="3"/></svg>
                <div class="text-xs font-bold text-purple-600">Mommy</div>
            </div>
            <div class="char-stamp-option" onclick="selectCharacterStamp('girl2')" title="Abigail">
                <svg viewBox="0 0 100 150" width="50" height="75"><circle cx="50" cy="30" r="20" fill="none" stroke="#000" stroke-width="3"/><path d="M30 10 L 15 60 M 70 10 L 85 60 M 30 10 Q 50 -5, 70 10" fill="none" stroke="#5D4037" stroke-width="3"/><circle cx="43" cy="28" r="2" fill="#000"/><circle cx="57" cy="28" r="2" fill="#000"/><path d="M40 38 Q 50 45, 60 38" fill="none" stroke="#000" stroke-width="2"/><path d="M50 50 L 25 120 L 75 120 Z" fill="#87CEEB" stroke="#000" stroke-width="3"/><path d="M40 60 L 15 20" fill="none" stroke="#000" stroke-width="3"/><path d="M60 60 L 85 20" fill="none" stroke="#000" stroke-width="3"/><path d="M40 120 L 35 145" fill="none" stroke="#000" stroke-width="3"/><path d="M60 120 L 65 145" fill="none" stroke="#000" stroke-width="3"/></svg>
                <div class="text-xs font-bold text-blue-500">Abigail</div>
            </div>
        </div>
        <div id="visibility-palette">
            <div class="text-sm font-bold text-gray-600 mb-1">Show/Hide Characters</div>
            <label class="visibility-toggle" data-char="ella">
                <input type="checkbox" checked onchange="toggleCharacterVisibility('ella', this.checked)">
                <span class="text-sm font-bold text-pink-500">Ella</span>
            </label>
            <label class="visibility-toggle" data-char="mommy">
                <input type="checkbox" checked onchange="toggleCharacterVisibility('mommy', this.checked)">
                <span class="text-sm font-bold text-purple-600">Mommy</span>
            </label>
            <label class="visibility-toggle" data-char="abigail">
                <input type="checkbox" checked onchange="toggleCharacterVisibility('abigail', this.checked)">
                <span class="text-sm font-bold text-blue-500">Abigail</span>
            </label>
            <hr class="my-1 border-gray-200">
            <button onclick="toggleAllCharacters(true)" class="text-xs text-green-600 hover:underline">Show All</button>
            <button onclick="toggleAllCharacters(false)" class="text-xs text-red-600 hover:underline">Hide All</button>
        </div>
        <div class="control-panel">
            <div class="flex space-x-2 border-r pr-4 border-gray-300">
                <button class="color-btn bg-red-600 active" onclick="activatePen('#dc2626', this)"></button><button class="color-btn bg-blue-600" onclick="activatePen('#2563eb', this)"></button><button class="color-btn bg-green-600" onclick="activatePen('#16a34a', this)"></button><button class="color-btn bg-yellow-600" onclick="activatePen('#ca8a04', this)"></button><button class="color-btn bg-purple-600" onclick="activatePen('#9333ea', this)"></button><button class="color-btn bg-black" onclick="activatePen('#000000', this)"></button>
            </div>
            <div class="flex space-x-2 border-r pr-4 border-gray-300 pl-2">
                <button id="eraser-btn" class="tool-btn" onclick="activateEraser()">üßΩ</button><button id="sticker-btn" class="tool-btn" onclick="toggleStickers()">ü¶ã</button><button id="character-btn" class="tool-btn" onclick="toggleCharacters()" title="Add Characters">üëß</button><button id="visibility-btn" class="tool-btn" onclick="toggleVisibilityPalette()" title="Show/Hide Characters">üëÅÔ∏è</button>
            </div>
            <div class="flex space-x-2">
                <button onclick="openTemplates()" class="px-4 py-2 bg-amber-500 hover:bg-amber-600 text-white rounded-full font-['Patrick_Hand'] text-lg shadow-md transition-all whitespace-nowrap" title="Change Card">üé®</button>
                <button onclick="openGallery()" class="px-4 py-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded-full font-['Patrick_Hand'] text-lg shadow-md transition-all whitespace-nowrap">üìÇ</button>
                <button onclick="promptForSave()" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-full font-['Patrick_Hand'] text-lg shadow-md transition-all whitespace-nowrap">üíæ</button>
                <button onclick="saveAsImageMobile()" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-full font-['Patrick_Hand'] text-lg shadow-md transition-all whitespace-nowrap">üì∑</button>
                <button onclick="celebrate()" class="px-4 py-2 bg-pink-500 hover:bg-pink-600 text-white rounded-full font-['Patrick_Hand'] text-lg shadow-md transition-all whitespace-nowrap">üéâ</button>
                <button id="record-btn" onclick="toggleRecording()" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-full font-['Patrick_Hand'] text-lg shadow-md transition-all whitespace-nowrap">üé¨</button>
            </div>
        </div>
    </div>


    <script>
        // Card Template Definitions
        const cardTemplates = {
            mommy: {
                title: "CONGRATS MOMMY!",
                subtitle: "We are so proud of your new job!",
                colors: ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEEAD', '#FFCC5C', '#FF6B6B', '#D4A5A5'],
                bgColor: '#fdf6e3',
                bgGradient: '#f4e9c8',
                dotColor: '#d4c5a3',
                characters: [
                    { label: 'YAY!', labelColor: 'text-pink-500', dress: '#FFB6C1', size: 'w-32 h-48' },
                    { label: 'HIRED!', labelColor: 'text-purple-600', dress: '#E6E6FA', size: 'w-40 h-64', isMain: true },
                    { label: 'WOOHOO!', labelColor: 'text-blue-500', dress: '#87CEEB', size: 'w-32 h-48' }
                ],
                stickers: ['‚ù§Ô∏è', 'üíñ', 'ü¶ã', 'üå∏', 'üå∑', '‚≠ê', 'üåà', 'ü¶Ñ', 'üëë', 'üéà']
            },
            birthday: {
                title: "HAPPY BIRTHDAY!",
                subtitle: "Wishing you an amazing day!",
                colors: ['#FF6B6B', '#FFD93D', '#6BCB77', '#4D96FF', '#FF6B6B', '#FFD93D', '#6BCB77', '#4D96FF'],
                bgColor: '#FFF5E6',
                bgGradient: '#FFE4C4',
                dotColor: '#FFD4A3',
                characters: [
                    { label: 'PARTY!', labelColor: 'text-orange-500', dress: '#FFD700', size: 'w-32 h-48' },
                    { label: 'YAY!', labelColor: 'text-pink-600', dress: '#FF69B4', size: 'w-40 h-64', isMain: true },
                    { label: 'CHEERS!', labelColor: 'text-purple-500', dress: '#9370DB', size: 'w-32 h-48' }
                ],
                stickers: ['üéÇ', 'üéà', 'üéÅ', 'üéâ', 'ü•≥', 'üéä', 'üç∞', 'üïØÔ∏è', 'üéÄ', '‚≠ê']
            },
            thankyou: {
                title: "THANK YOU!",
                subtitle: "Your kindness means the world!",
                colors: ['#2ECC71', '#27AE60', '#1ABC9C', '#16A085', '#2ECC71', '#27AE60', '#1ABC9C', '#16A085'],
                bgColor: '#E8F8F5',
                bgGradient: '#D5F5E3',
                dotColor: '#A9DFBF',
                characters: [
                    { label: 'THANKS!', labelColor: 'text-green-500', dress: '#98D8C8', size: 'w-32 h-48' },
                    { label: 'SO KIND!', labelColor: 'text-teal-600', dress: '#48C9B0', size: 'w-40 h-64', isMain: true },
                    { label: 'HUGS!', labelColor: 'text-emerald-500', dress: '#7DCEA0', size: 'w-32 h-48' }
                ],
                stickers: ['üôè', 'üíö', 'üåø', 'üçÄ', 'üåª', '‚ú®', 'üíù', 'ü§ó', 'üå∏', 'ü¶ã']
            },
            getwell: {
                title: "GET WELL SOON!",
                subtitle: "Sending healing hugs your way!",
                colors: ['#85C1E9', '#5DADE2', '#3498DB', '#2E86C1', '#85C1E9', '#5DADE2', '#3498DB', '#2E86C1'],
                bgColor: '#EBF5FB',
                bgGradient: '#D6EAF8',
                dotColor: '#AED6F1',
                characters: [
                    { label: 'REST UP!', labelColor: 'text-blue-400', dress: '#AED6F1', size: 'w-32 h-48' },
                    { label: 'FEEL BETTER!', labelColor: 'text-blue-600', dress: '#5DADE2', size: 'w-40 h-64', isMain: true },
                    { label: 'HUGS!', labelColor: 'text-cyan-500', dress: '#76D7C4', size: 'w-32 h-48' }
                ],
                stickers: ['üíê', 'üå∑', 'üíä', 'ü©π', '‚ù§Ô∏è‚Äçü©π', 'üß∏', '‚òÄÔ∏è', 'üåà', 'üíô', 'ü¶ã']
            },
            congrats: {
                title: "CONGRATULATIONS!",
                subtitle: "You did it! So proud of you!",
                colors: ['#F1C40F', '#F39C12', '#E67E22', '#D35400', '#F1C40F', '#F39C12', '#E67E22', '#D35400'],
                bgColor: '#FEF9E7',
                bgGradient: '#FCF3CF',
                dotColor: '#F9E79F',
                characters: [
                    { label: 'WOW!', labelColor: 'text-amber-500', dress: '#F4D03F', size: 'w-32 h-48' },
                    { label: 'AMAZING!', labelColor: 'text-orange-600', dress: '#F5B041', size: 'w-40 h-64', isMain: true },
                    { label: 'BRAVO!', labelColor: 'text-yellow-500', dress: '#EB984E', size: 'w-32 h-48' }
                ],
                stickers: ['üéâ', 'üèÜ', 'ü•á', '‚≠ê', 'üåü', 'üëè', 'üéä', '‚ú®', 'üí™', 'üî•']
            },
            love: {
                title: "I LOVE YOU!",
                subtitle: "You mean everything to me!",
                colors: ['#E74C3C', '#EC7063', '#F1948A', '#E74C3C', '#C0392B', '#EC7063', '#F1948A', '#C0392B'],
                bgColor: '#FDEDEC',
                bgGradient: '#FADBD8',
                dotColor: '#F5B7B1',
                characters: [
                    { label: 'XOXO!', labelColor: 'text-red-400', dress: '#F1948A', size: 'w-32 h-48' },
                    { label: 'FOREVER!', labelColor: 'text-red-600', dress: '#E74C3C', size: 'w-40 h-64', isMain: true },
                    { label: 'HUGS!', labelColor: 'text-pink-500', dress: '#F8B4B4', size: 'w-32 h-48' }
                ],
                stickers: ['‚ù§Ô∏è', 'üíï', 'üíñ', 'üíó', 'üíò', 'üíù', 'üòò', 'ü•∞', 'üíë', 'üåπ']
            }
        };

        let currentTemplate = 'mommy';
        let colors = cardTemplates.mommy.colors;

        function openTemplates() {
            document.getElementById('template-modal').style.display = 'flex';
        }

        function selectTemplate(templateKey) {
            currentTemplate = templateKey;
            const template = cardTemplates[templateKey];
            colors = template.colors;

            // Update page title
            document.title = template.title.replace('!', '') + ' Card';

            // Update background
            const container = document.getElementById('card-container');
            container.style.backgroundColor = template.bgColor;
            container.style.backgroundImage = `radial-gradient(${template.dotColor} 1px, transparent 1px), linear-gradient(to bottom, ${template.bgColor} 0%, ${template.bgGradient} 100%)`;

            // Update title
            const titleContainer = document.getElementById('main-title');
            titleContainer.innerHTML = '';
            template.title.split('').forEach((char, index) => {
                const span = document.createElement('span');
                span.textContent = char === ' ' ? '\u00A0' : char;
                span.className = 'letter';
                span.style.color = template.colors[index % template.colors.length];
                span.style.display = 'inline-block';
                span.style.animation = `wiggle 3s ease-in-out infinite`;
                span.style.animationDelay = `${index * 0.1}s`;
                titleContainer.appendChild(span);
            });

            // Update subtitle
            document.getElementById('subtitle-text').textContent = template.subtitle;

            // Update characters
            updateCharacters(template);

            // Update sticker palette
            updateStickerPalette(template.stickers);

            closeModals();
        }

        function updateCharacters(template) {
            const charContainer = document.getElementById('characters-container');
            charContainer.innerHTML = '';

            template.characters.forEach((char, index) => {
                let characterHTML = '';

                if (index === 0) {
                    // Ella - wavy hair, arms down
                    characterHTML = `
                        <div class="character group relative ${char.size}" onclick="characterJump(this)" data-character="ella">
                            <div class="absolute -top-12 opacity-0 group-hover:opacity-100 transition-opacity text-xl font-bold ${char.labelColor} w-full text-center">${char.label}</div>
                            <svg viewBox="0 0 100 150" class="w-full h-full overflow-visible">
                                <circle cx="50" cy="30" r="20" fill="none" stroke="#000" stroke-width="3" filter="url(#rough-paper)"/>
                                <path d="M25 30 Q 15 20, 25 10 Q 35 0, 50 5 Q 65 0, 75 10 Q 85 20, 75 30" fill="none" stroke="#8B4513" stroke-width="3" filter="url(#rough-paper)"/>
                                <circle cx="43" cy="28" r="2" fill="#000"/>
                                <circle cx="57" cy="28" r="2" fill="#000"/>
                                <path d="M40 38 Q 50 45, 60 38" fill="none" stroke="#000" stroke-width="2"/>
                                <path d="M50 50 L 25 120 L 75 120 Z" fill="${char.dress}" stroke="#000" stroke-width="3" filter="url(#rough-paper)"/>
                                <path d="M40 60 L 10 40" fill="none" stroke="#000" stroke-width="3" class="origin-bottom-right animate-wiggle"/>
                                <path d="M60 60 L 90 40" fill="none" stroke="#000" stroke-width="3" class="origin-bottom-left animate-wiggle" style="animation-delay: 0.5s"/>
                                <path d="M40 120 L 35 145" fill="none" stroke="#000" stroke-width="3"/>
                                <path d="M60 120 L 65 145" fill="none" stroke="#000" stroke-width="3"/>
                            </svg>
                        </div>
                    `;
                } else if (index === 1) {
                    // Mommy - taller, with glasses
                    characterHTML = `
                        <div class="character group relative ${char.size}" onclick="characterJump(this)" data-character="mommy">
                            <div class="absolute -top-12 opacity-0 group-hover:opacity-100 transition-opacity text-2xl font-bold ${char.labelColor} w-full text-center">${char.label}</div>
                            <svg viewBox="0 0 100 200" class="w-full h-full overflow-visible">
                                <circle cx="50" cy="35" r="25" fill="none" stroke="#000" stroke-width="3" filter="url(#rough-paper)"/>
                                <path d="M20 35 C 10 10, 40 0, 50 5 C 60 0, 90 10, 80 35 L 85 80 L 15 80 Z" fill="#333" fill-opacity="0.1" stroke="#333" stroke-width="3" filter="url(#rough-paper)"/>
                                <g stroke="#000" stroke-width="2" fill="none">
                                    <circle cx="40" cy="35" r="8"/>
                                    <circle cx="60" cy="35" r="8"/>
                                    <line x1="48" y1="35" x2="52" y2="35"/>
                                    <line x1="32" y1="35" x2="25" y2="32"/>
                                    <line x1="68" y1="35" x2="75" y2="32"/>
                                </g>
                                <path d="M38 48 Q 50 55, 62 48" fill="none" stroke="#000" stroke-width="2"/>
                                <path d="M50 60 L 25 150 L 75 150 Z" fill="${char.dress}" stroke="#000" stroke-width="3" filter="url(#rough-paper)"/>
                                <line x1="45" y1="75" x2="55" y2="75" stroke="#000" stroke-width="2"/>
                                <line x1="40" y1="90" x2="60" y2="90" stroke="#000" stroke-width="2"/>
                                <path d="M40 70 L 10 90" fill="none" stroke="#000" stroke-width="3"/>
                                <path d="M60 70 L 90 90" fill="none" stroke="#000" stroke-width="3"/>
                                <path d="M40 150 L 40 190" fill="none" stroke="#000" stroke-width="3"/>
                                <path d="M60 150 L 60 190" fill="none" stroke="#000" stroke-width="3"/>
                            </svg>
                        </div>
                    `;
                } else {
                    // Abigail - pigtails, arms up
                    characterHTML = `
                        <div class="character group relative ${char.size}" onclick="characterJump(this)" data-character="abigail">
                            <div class="absolute -top-12 opacity-0 group-hover:opacity-100 transition-opacity text-xl font-bold ${char.labelColor} w-full text-center">${char.label}</div>
                            <svg viewBox="0 0 100 150" class="w-full h-full overflow-visible">
                                <circle cx="50" cy="30" r="20" fill="none" stroke="#000" stroke-width="3" filter="url(#rough-paper)"/>
                                <path d="M30 10 L 15 60 M 70 10 L 85 60 M 30 10 Q 50 -5, 70 10" fill="none" stroke="#5D4037" stroke-width="3" filter="url(#rough-paper)"/>
                                <circle cx="43" cy="28" r="2" fill="#000"/>
                                <circle cx="57" cy="28" r="2" fill="#000"/>
                                <path d="M40 38 Q 50 45, 60 38" fill="none" stroke="#000" stroke-width="2"/>
                                <path d="M50 50 L 25 120 L 75 120 Z" fill="${char.dress}" stroke="#000" stroke-width="3" filter="url(#rough-paper)"/>
                                <path d="M40 60 L 15 20" fill="none" stroke="#000" stroke-width="3" class="origin-bottom-right animate-wiggle"/>
                                <path d="M60 60 L 85 20" fill="none" stroke="#000" stroke-width="3" class="origin-bottom-left animate-wiggle" style="animation-delay: 0.3s"/>
                                <path d="M40 120 L 35 145" fill="none" stroke="#000" stroke-width="3"/>
                                <path d="M60 120 L 65 145" fill="none" stroke="#000" stroke-width="3"/>
                            </svg>
                        </div>
                    `;
                }
                charContainer.innerHTML += characterHTML;
            });
        }

        function updateStickerPalette(stickers) {
            const palette = document.getElementById('sticker-palette');
            palette.innerHTML = '';
            stickers.forEach(sticker => {
                const div = document.createElement('div');
                div.className = 'sticker-option';
                div.textContent = sticker;
                div.onclick = () => selectSticker(sticker);
                palette.appendChild(div);
            });
            currentSticker = stickers[0];
        }

        // Initialize with default template
        const titleContainer = document.getElementById('main-title');
        const defaultTemplate = cardTemplates[currentTemplate];
        defaultTemplate.title.split('').forEach((char, index) => {
            const span = document.createElement('span'); span.textContent = char === ' ' ? '\u00A0' : char; span.className = 'letter'; span.style.color = defaultTemplate.colors[index % defaultTemplate.colors.length]; span.style.display = 'inline-block'; span.style.animation = `wiggle 3s ease-in-out infinite`; span.style.animationDelay = `${index * 0.1}s`; titleContainer.appendChild(span);
        });


        const canvas = document.getElementById('drawing-canvas');
        const cardContainer = document.getElementById('card-container');
        const ctx = canvas.getContext('2d');
        let allStrokes = [], currentStroke = null, mode = 'pen', isDrawing = false, lastX = 0, lastY = 0, currentPenColor = '#dc2626', currentSticker = '‚ù§Ô∏è';
        let currentCharacter = 'girl1'; // girl1, mommy, girl2
        let generatedImgData = null; // Store for download


        function resizeCanvas() { if (!cardContainer) return; canvas.width = cardContainer.clientWidth; canvas.height = cardContainer.clientHeight; ctx.lineJoin = 'round'; ctx.lineCap = 'round'; redrawAll(); }
        window.addEventListener('resize', resizeCanvas);


        function redrawAll() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            allStrokes.forEach(stroke => {
                if (stroke.type === 'sticker') {
                    ctx.globalCompositeOperation = 'source-over'; ctx.font = "50px Arial"; ctx.textAlign = "center"; ctx.textBaseline = "middle"; ctx.fillText(stroke.sticker, stroke.x * canvas.width, stroke.y * canvas.height);
                } else if (stroke.type === 'character') {
                    ctx.globalCompositeOperation = 'source-over';
                    drawCharacter(stroke.character, stroke.x * canvas.width, stroke.y * canvas.height, stroke.dressColor);
                } else {
                    ctx.globalCompositeOperation = stroke.type === 'eraser' ? 'destination-out' : 'source-over'; ctx.strokeStyle = stroke.color; ctx.lineWidth = stroke.type === 'eraser' ? 30 : 5;
                    if (stroke.points.length > 0) {
                        ctx.beginPath(); ctx.moveTo(stroke.points[0].x * canvas.width, stroke.points[0].y * canvas.height);
                        for (let i = 1; i < stroke.points.length; i++) ctx.lineTo(stroke.points[i].x * canvas.width, stroke.points[i].y * canvas.height);
                        ctx.stroke();
                    }
                }
            });
            ctx.globalCompositeOperation = mode === 'eraser' ? 'destination-out' : 'source-over'; ctx.lineWidth = mode === 'eraser' ? 30 : 5; ctx.strokeStyle = currentPenColor;
        }


        function getPos(e) {
            const rect = canvas.getBoundingClientRect(); const clientX = e.clientX || e.touches[0].clientX; const clientY = e.clientY || e.touches[0].clientY;
            return { x: clientX - rect.left, y: clientY - rect.top, relX: (clientX - rect.left) / canvas.width, relY: (clientY - rect.top) / canvas.height };
        }


        function startInteraction(e) {
            const hint = document.getElementById('hint-text'); if(hint) hint.remove();
            if (e.target.closest('.ui-wrapper') || e.target.closest('.modal-overlay')) return;
            const pos = getPos(e);
            if (mode === 'stamp') {
                allStrokes.push({ type: 'sticker', sticker: currentSticker, x: pos.relX, y: pos.relY });
                ctx.globalCompositeOperation = 'source-over'; ctx.font = "50px Arial"; ctx.textAlign = "center"; ctx.textBaseline = "middle"; ctx.fillText(currentSticker, pos.x, pos.y);
                return;
            }
            if (mode === 'character') {
                const template = cardTemplates[currentTemplate];
                const charData = template.characters.find(c =>
                    (currentCharacter === 'girl1' && !c.isMain && template.characters.indexOf(c) === 0) ||
                    (currentCharacter === 'mommy' && c.isMain) ||
                    (currentCharacter === 'girl2' && !c.isMain && template.characters.indexOf(c) === 2)
                ) || template.characters[currentCharacter === 'mommy' ? 1 : currentCharacter === 'girl1' ? 0 : 2];
                const dressColor = charData ? charData.dress : '#FFB6C1';
                allStrokes.push({ type: 'character', character: currentCharacter, x: pos.relX, y: pos.relY, dressColor: dressColor });
                ctx.globalCompositeOperation = 'source-over';
                drawCharacter(currentCharacter, pos.x, pos.y, dressColor);
                return;
            }
            isDrawing = true; lastX = pos.x; lastY = pos.y;
            currentStroke = { type: mode, color: currentPenColor, points: [{x: pos.relX, y: pos.relY}] };
        }


        function moveInteraction(e) {
            if (!isDrawing || mode === 'stamp' || mode === 'character') return;
            const pos = getPos(e);
            if (mode === 'eraser') { ctx.globalCompositeOperation = 'destination-out'; ctx.lineWidth = 30; ctx.beginPath(); ctx.moveTo(lastX, lastY); ctx.lineTo(pos.x, pos.y); ctx.stroke(); } 
            else { ctx.globalCompositeOperation = 'source-over'; ctx.strokeStyle = currentPenColor; ctx.lineWidth = 5; ctx.beginPath(); ctx.moveTo(lastX, lastY); ctx.lineTo(pos.x, pos.y); ctx.stroke(); }
            if (currentStroke) currentStroke.points.push({x: pos.relX, y: pos.relY});
            lastX = pos.x; lastY = pos.y;
        }


        function endInteraction() { if (isDrawing && currentStroke) { allStrokes.push(currentStroke); currentStroke = null; } isDrawing = false; }
        
        canvas.addEventListener('mousedown', startInteraction); canvas.addEventListener('mousemove', moveInteraction); canvas.addEventListener('mouseup', endInteraction);
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); startInteraction(e); }, {passive: false}); canvas.addEventListener('touchmove', (e) => { e.preventDefault(); moveInteraction(e); }, {passive: false}); canvas.addEventListener('touchend', endInteraction);


        function closeModals() { document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none'); }
        function promptForSave() { document.getElementById('save-modal').style.display = 'flex'; document.getElementById('drawing-name-input').focus(); }
        function finalizeSave() {
            const name = document.getElementById('drawing-name-input').value.trim(); if (!name) return;
            const savedDrawings = JSON.parse(localStorage.getItem('mommy_card_drawings') || '{}');
            savedDrawings[name] = allStrokes; localStorage.setItem('mommy_card_drawings', JSON.stringify(savedDrawings));
            closeModals(); showFlash();
        }
        function openGallery() {
            const savedDrawings = JSON.parse(localStorage.getItem('mommy_card_drawings') || '{}'); const keys = Object.keys(savedDrawings); const list = document.getElementById('gallery-list'); list.innerHTML = '';
            if (keys.length === 0) list.innerHTML = '<p class="text-center p-4 text-gray-500">No drawings found.</p>';
            else keys.forEach(key => {
                const div = document.createElement('div'); div.className = 'saved-item';
                div.innerHTML = `<span class="text-xl font-hand">${key}</span><div><button class="text-blue-500 font-bold px-3" onclick="loadDrawing('${key}')">Load</button><button class="text-red-500 px-3" onclick="deleteDrawing('${key}')">‚úï</button></div>`;
                list.appendChild(div);
            });
            document.getElementById('gallery-modal').style.display = 'flex';
        }
        function loadDrawing(key) {
            const savedDrawings = JSON.parse(localStorage.getItem('mommy_card_drawings') || '{}');
            if (savedDrawings[key]) { allStrokes = savedDrawings[key]; redrawAll(); closeModals(); }
        }
        function deleteDrawing(key) {
            if(!confirm("Delete this?")) return;
            const savedDrawings = JSON.parse(localStorage.getItem('mommy_card_drawings') || '{}');
            delete savedDrawings[key]; localStorage.setItem('mommy_card_drawings', JSON.stringify(savedDrawings)); openGallery();
        }


        // --- NEW: BACKUP FEATURES (IMPORT/EXPORT) ---
        function exportData() {
            const data = localStorage.getItem('mommy_card_drawings') || '{}';
            const blob = new Blob([data], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'mommy_card_backup.json';
            a.click();
        }


        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const newData = JSON.parse(e.target.result);
                    const currentData = JSON.parse(localStorage.getItem('mommy_card_drawings') || '{}');
                    // Merge new data with existing
                    const merged = {...currentData, ...newData};
                    localStorage.setItem('mommy_card_drawings', JSON.stringify(merged));
                    openGallery();
                    alert("Import successful!");
                } catch(err) {
                    alert("Could not load file. Is it a valid backup?");
                }
            };
            reader.readAsText(file);
        }


        function saveAsImageMobile() {
            const el = document.getElementById("card-container");
            const ui = document.querySelector('.ui-wrapper');
            ui.style.display = 'none';
            html2canvas(el, { scale: 2, backgroundColor: '#fdf6e3', useCORS: true }).then(canvas => {
                ui.style.display = 'flex';
                generatedImgData = canvas.toDataURL("image/jpeg", 0.9);
                const img = new Image(); img.src = generatedImgData; img.style.width = "100%"; img.style.borderRadius = "8px"; img.style.userSelect = "none"; img.style.webkitUserSelect = "none";
                const container = document.getElementById('img-result-container'); container.innerHTML = ''; container.appendChild(img);
                document.getElementById('image-modal').style.display = 'flex';
            }).catch(e => { ui.style.display = 'flex'; alert("Error. Please try again."); });
        }


        // Android Trigger for Auto-Download
        function triggerDownload() {
            if (!generatedImgData) return;
            const link = document.getElementById('download-link');
            link.href = generatedImgData;
            link.download = 'congrats-mommy-card.jpg';
            link.click();
        }


        function showFlash() { const f = document.getElementById('flash'); f.style.opacity = '1'; setTimeout(() => f.style.opacity = '0', 200); }
        function resetUI() { document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active')); document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active')); document.getElementById('sticker-palette').classList.remove('show'); document.getElementById('character-palette').classList.remove('show'); document.getElementById('visibility-palette').classList.remove('show'); }
        function activatePen(color, btn) { mode = 'pen'; currentPenColor = color; resetUI(); btn.classList.add('active'); }
        function activateEraser() { mode = 'eraser'; resetUI(); document.getElementById('eraser-btn').classList.add('active'); }
        function toggleStickers() { const p = document.getElementById('sticker-palette'); const b = document.getElementById('sticker-btn'); if(p.classList.contains('show')) { p.classList.remove('show'); } else { resetUI(); b.classList.add('active'); p.classList.add('show'); mode = 'stamp'; } }
        function selectSticker(s) { currentSticker = s; mode = 'stamp'; document.querySelectorAll('.sticker-option').forEach(o => o.classList.toggle('selected', o.innerText === s)); }
        function toggleCharacters() { const p = document.getElementById('character-palette'); const b = document.getElementById('character-btn'); if(p.classList.contains('show')) { p.classList.remove('show'); } else { resetUI(); b.classList.add('active'); p.classList.add('show'); mode = 'character'; } }
        function selectCharacterStamp(charType) { currentCharacter = charType; mode = 'character'; document.querySelectorAll('.char-stamp-option').forEach(o => o.classList.remove('selected')); event.currentTarget.classList.add('selected'); }

        function toggleVisibilityPalette() {
            const p = document.getElementById('visibility-palette');
            const b = document.getElementById('visibility-btn');
            if(p.classList.contains('show')) {
                p.classList.remove('show');
                b.classList.remove('active');
            } else {
                document.getElementById('sticker-palette').classList.remove('show');
                document.getElementById('character-palette').classList.remove('show');
                document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
                b.classList.add('active');
                p.classList.add('show');
            }
        }

        function toggleCharacterVisibility(charName, visible) {
            const container = document.getElementById('characters-container');
            const char = container.querySelector(`[data-character="${charName}"]`);
            if (char) {
                char.style.display = visible ? '' : 'none';
            }
            // Update toggle label style
            const toggle = document.querySelector(`.visibility-toggle[data-char="${charName}"]`);
            if (toggle) {
                toggle.classList.toggle('hidden', !visible);
            }
        }

        function toggleAllCharacters(show) {
            const checkboxes = document.querySelectorAll('#visibility-palette input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = show;
                const charName = cb.closest('.visibility-toggle').dataset.char;
                toggleCharacterVisibility(charName, show);
            });
        }

        function drawCharacter(charType, x, y, dressColor) {
            const scale = 0.8;
            const isMommy = charType === 'mommy';
            const height = isMommy ? 120 * scale : 90 * scale;
            const width = isMommy ? 60 * scale : 50 * scale;

            ctx.save();
            ctx.translate(x, y);
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            if (isMommy) {
                // Head
                ctx.beginPath();
                ctx.arc(0, -height * 0.7, width * 0.4, 0, Math.PI * 2);
                ctx.stroke();
                // Hair
                ctx.beginPath();
                ctx.strokeStyle = '#333';
                ctx.moveTo(-width * 0.4, -height * 0.7);
                ctx.quadraticCurveTo(-width * 0.5, -height * 0.95, 0, -height * 0.9);
                ctx.quadraticCurveTo(width * 0.5, -height * 0.95, width * 0.4, -height * 0.7);
                ctx.stroke();
                ctx.strokeStyle = '#000';
                // Eyes
                ctx.beginPath();
                ctx.arc(-width * 0.15, -height * 0.72, 3, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(width * 0.15, -height * 0.72, 3, 0, Math.PI * 2);
                ctx.fill();
                // Smile
                ctx.beginPath();
                ctx.arc(0, -height * 0.65, width * 0.15, 0.1 * Math.PI, 0.9 * Math.PI);
                ctx.stroke();
                // Body/Dress
                ctx.beginPath();
                ctx.fillStyle = dressColor;
                ctx.moveTo(0, -height * 0.45);
                ctx.lineTo(-width * 0.4, height * 0.15);
                ctx.lineTo(width * 0.4, height * 0.15);
                ctx.closePath();
                ctx.fill();
                ctx.stroke();
                // Arms
                ctx.beginPath();
                ctx.moveTo(-width * 0.2, -height * 0.35);
                ctx.lineTo(-width * 0.6, -height * 0.2);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(width * 0.2, -height * 0.35);
                ctx.lineTo(width * 0.6, -height * 0.2);
                ctx.stroke();
                // Legs
                ctx.beginPath();
                ctx.moveTo(-width * 0.15, height * 0.15);
                ctx.lineTo(-width * 0.15, height * 0.4);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(width * 0.15, height * 0.15);
                ctx.lineTo(width * 0.15, height * 0.4);
                ctx.stroke();
            } else {
                // Girl characters
                const isGirl2 = charType === 'girl2';
                // Head
                ctx.beginPath();
                ctx.arc(0, -height * 0.65, width * 0.35, 0, Math.PI * 2);
                ctx.stroke();
                // Hair
                ctx.strokeStyle = isGirl2 ? '#5D4037' : '#8B4513';
                if (isGirl2) {
                    // Pigtails style
                    ctx.beginPath();
                    ctx.moveTo(-width * 0.3, -height * 0.8);
                    ctx.lineTo(-width * 0.5, -height * 0.3);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(width * 0.3, -height * 0.8);
                    ctx.lineTo(width * 0.5, -height * 0.3);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(-width * 0.3, -height * 0.8);
                    ctx.quadraticCurveTo(0, -height * 0.95, width * 0.3, -height * 0.8);
                    ctx.stroke();
                } else {
                    // Wavy hair
                    ctx.beginPath();
                    ctx.moveTo(-width * 0.35, -height * 0.65);
                    ctx.quadraticCurveTo(-width * 0.45, -height * 0.85, -width * 0.25, -height * 0.9);
                    ctx.quadraticCurveTo(0, -height * 0.95, width * 0.25, -height * 0.9);
                    ctx.quadraticCurveTo(width * 0.45, -height * 0.85, width * 0.35, -height * 0.65);
                    ctx.stroke();
                }
                ctx.strokeStyle = '#000';
                // Eyes
                ctx.beginPath();
                ctx.arc(-width * 0.12, -height * 0.67, 2, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(width * 0.12, -height * 0.67, 2, 0, Math.PI * 2);
                ctx.fill();
                // Smile
                ctx.beginPath();
                ctx.arc(0, -height * 0.6, width * 0.12, 0.1 * Math.PI, 0.9 * Math.PI);
                ctx.stroke();
                // Body/Dress
                ctx.beginPath();
                ctx.fillStyle = dressColor;
                ctx.moveTo(0, -height * 0.4);
                ctx.lineTo(-width * 0.4, height * 0.2);
                ctx.lineTo(width * 0.4, height * 0.2);
                ctx.closePath();
                ctx.fill();
                ctx.stroke();
                // Arms
                const armUpY = isGirl2 ? -height * 0.55 : -height * 0.25;
                ctx.beginPath();
                ctx.moveTo(-width * 0.2, -height * 0.3);
                ctx.lineTo(-width * 0.6, armUpY);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(width * 0.2, -height * 0.3);
                ctx.lineTo(width * 0.6, armUpY);
                ctx.stroke();
                // Legs
                ctx.beginPath();
                ctx.moveTo(-width * 0.15, height * 0.2);
                ctx.lineTo(-width * 0.2, height * 0.45);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(width * 0.15, height * 0.2);
                ctx.lineTo(width * 0.2, height * 0.45);
                ctx.stroke();
            }
            ctx.restore();
        }
        function characterJump(element) { element.style.transform = "translateY(-50px) scale(1.1)"; setTimeout(() => { element.style.transform = "translateY(0) scale(1)"; }, 300); const rect = element.getBoundingClientRect(); confetti({ particleCount: 30, spread: 50, origin: { x: (rect.left + rect.width / 2) / window.innerWidth, y: (rect.top + rect.height / 2) / window.innerHeight }, colors: ['#FFB6C1', '#87CEEB', '#E6E6FA'] }); }
        function celebrate() { const duration = 3000; const end = Date.now() + duration; (function frame() { confetti({ particleCount: 5, angle: 60, spread: 55, origin: { x: 0 }, colors: colors }); confetti({ particleCount: 5, angle: 120, spread: 55, origin: { x: 1 }, colors: colors }); if (Date.now() < end) requestAnimationFrame(frame); }()); }


        window.onload = function() { resizeCanvas(); setTimeout(() => { const centerX = canvas.width * 0.8; const centerY = canvas.height * 0.2; ctx.strokeStyle = '#dc2626'; ctx.lineWidth = 4; ctx.beginPath(); ctx.moveTo(centerX, centerY); ctx.bezierCurveTo(centerX, centerY - 30, centerX - 50, centerY - 30, centerX - 50, centerY); ctx.bezierCurveTo(centerX - 50, centerY + 30, centerX, centerY + 60, centerX, centerY + 80); ctx.bezierCurveTo(centerX, centerY + 60, centerX + 50, centerY + 30, centerX + 50, centerY); ctx.bezierCurveTo(centerX + 50, centerY - 30, centerX, centerY - 30, centerX, centerY); ctx.stroke(); }, 500); };


        // VIDEO RECORDING FEATURE
        let mediaRecorder = null;
        let recordedChunks = [];
        let capturedFrames = []; // Store frames for GIF encoding
        let isRecording = false;
        let recordingCanvas = null;
        let recordingContext = null;
        let recordingStream = null;

        async function toggleRecording() {
            if (isRecording) {
                return; // Don't allow stopping early
            } else {
                await startRecording();
            }
        }

        async function startRecording() {
            try {
                const recordBtn = document.getElementById('record-btn');
                recordBtn.textContent = '‚è∫Ô∏è';
                recordBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                recordBtn.classList.add('bg-gray-600', 'hover:bg-gray-700');

                recordedChunks = [];
                capturedFrames = [];
                isRecording = true;

                // Hide UI for recording
                const ui = document.querySelector('.ui-wrapper');
                ui.style.display = 'none';

                // Create offscreen canvas for recording
                const cardContainer = document.getElementById('card-container');
                recordingCanvas = document.createElement('canvas');
                recordingCanvas.width = cardContainer.clientWidth;
                recordingCanvas.height = cardContainer.clientHeight;
                recordingContext = recordingCanvas.getContext('2d');

                // Get stream from canvas
                recordingStream = recordingCanvas.captureStream(30); // 30 FPS

                // Set up MediaRecorder
                const options = {
                    mimeType: 'video/webm;codecs=vp9',
                    videoBitsPerSecond: 2500000
                };

                // Fallback for browsers that don't support vp9
                if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                    options.mimeType = 'video/webm;codecs=vp8';
                    if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                        options.mimeType = 'video/webm';
                    }
                }

                mediaRecorder = new MediaRecorder(recordingStream, options);

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data && event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    ui.style.display = 'flex';
                    showDownloadModal();
                    if (recordingStream) {
                        recordingStream.getTracks().forEach(track => track.stop());
                    }
                };

                mediaRecorder.start(100); // Collect data every 100ms

                // Start capturing frames
                captureFrames();

                // Automatically trigger confetti after a brief delay
                setTimeout(() => {
                    celebrate();
                }, 100);

                // Auto-stop after 4 seconds (confetti duration is 3 seconds + 1 second buffer)
                setTimeout(() => {
                    stopRecording();
                }, 4000);

            } catch (error) {
                console.error('Error starting recording:', error);
                alert('Could not start recording: ' + error.message);
                document.querySelector('.ui-wrapper').style.display = 'flex';
                resetRecordingButton();
                isRecording = false;
            }
        }

        function captureFrames() {
            if (!isRecording || !recordingContext) return;

            const cardContainer = document.getElementById('card-container');

            // Use html2canvas to capture the current frame
            html2canvas(cardContainer, {
                scale: 1,
                backgroundColor: null,
                logging: false,
                useCORS: true
            }).then(capturedCanvas => {
                if (recordingContext && isRecording) {
                    // Draw the captured frame to our recording canvas
                    recordingContext.clearRect(0, 0, recordingCanvas.width, recordingCanvas.height);
                    recordingContext.drawImage(capturedCanvas, 0, 0);

                    // Store frame for GIF encoding (reduce size for GIF)
                    const gifCanvas = document.createElement('canvas');
                    // More aggressive size reduction for mobile
                    const isMobile = /iPad|iPhone|iPod|Android/i.test(navigator.userAgent);
                    const maxWidth = isMobile ? 480 : 600; // Smaller for mobile
                    const scale = Math.min(1, maxWidth / capturedCanvas.width);
                    gifCanvas.width = capturedCanvas.width * scale;
                    gifCanvas.height = capturedCanvas.height * scale;
                    const gifCtx = gifCanvas.getContext('2d');
                    gifCtx.drawImage(capturedCanvas, 0, 0, gifCanvas.width, gifCanvas.height);

                    // Store fewer frames on mobile (every 5th frame vs every 3rd)
                    const frameInterval = isMobile ? 5 : 3;
                    if (capturedFrames.length % frameInterval === 0 || capturedFrames.length === 0) {
                        capturedFrames.push(gifCanvas);
                    }

                    // Continue capturing frames at ~30 FPS
                    setTimeout(() => captureFrames(), 33);
                }
            }).catch(err => {
                console.error('Frame capture error:', err);
                // Continue trying to capture frames
                if (isRecording) {
                    setTimeout(() => captureFrames(), 33);
                }
            });
        }

        function stopRecording() {
            if (!isRecording) return;

            isRecording = false;

            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }

            resetRecordingButton();
        }

        function resetRecordingButton() {
            const recordBtn = document.getElementById('record-btn');
            recordBtn.textContent = 'üé¨';
            recordBtn.classList.remove('bg-gray-600', 'hover:bg-gray-700');
            recordBtn.classList.add('bg-red-500', 'hover:bg-red-600');
        }

        function showDownloadModal() {
            if (recordedChunks.length === 0) {
                alert('No recording data available. The recording may have failed.');
                return;
            }
            document.getElementById('video-modal').style.display = 'flex';
        }

        function downloadAsVideo() {
            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `mommy-card-celebration-${Date.now()}.webm`;
            document.body.appendChild(a);
            a.click();

            // Cleanup
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);

            showFlash();
            closeModals();
        }

        function downloadAsGif() {
            if (capturedFrames.length === 0) {
                alert('No frames captured for GIF');
                return;
            }

            // Disable button and show processing message
            const gifBtn = document.getElementById('gif-download-btn');
            const originalHTML = gifBtn.innerHTML;
            gifBtn.disabled = true;
            gifBtn.innerHTML = '<span>‚è≥</span><span>Creating GIF...</span>';

            console.log(`Starting GIF creation with ${capturedFrames.length} frames at ${capturedFrames[0].width}x${capturedFrames[0].height}`);

            // Detect mobile for optimized settings
            const isMobile = /iPad|iPhone|iPod|Android/i.test(navigator.userAgent);

            // Create GIF using gif.js with mobile-optimized settings
            const gif = new GIF({
                workers: isMobile ? 1 : 2, // Use 1 worker on mobile for better compatibility
                quality: isMobile ? 20 : 10, // Lower quality on mobile (higher number = lower quality)
                width: capturedFrames[0].width,
                height: capturedFrames[0].height,
                workerScript: 'https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.worker.js',
                debug: true
            });

            // Set timeout to detect if GIF creation hangs (30 seconds)
            const timeoutId = setTimeout(() => {
                console.error('GIF creation timeout');
                alert('GIF creation is taking too long. Try again or use the video option instead.');
                gifBtn.disabled = false;
                gifBtn.innerHTML = originalHTML;
                gif.abort();
            }, 30000);

            // Add frames to GIF with longer delay on mobile
            const frameDelay = isMobile ? 150 : 100; // Slower animation on mobile
            capturedFrames.forEach((frameCanvas, index) => {
                gif.addFrame(frameCanvas, { delay: frameDelay });
            });

            gif.on('finished', (blob) => {
                clearTimeout(timeoutId);
                console.log('GIF created successfully, size:', blob.size);

                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `mommy-card-celebration-${Date.now()}.gif`;
                document.body.appendChild(a);
                a.click();

                // Cleanup
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);

                showFlash();
                closeModals();

                // Reset button
                gifBtn.disabled = false;
                gifBtn.innerHTML = originalHTML;

                // Cleanup frames
                recordingCanvas = null;
                recordingContext = null;
                capturedFrames = [];
            });

            gif.on('progress', (progress) => {
                const percent = Math.round(progress * 100);
                console.log('GIF progress:', percent + '%');
                gifBtn.innerHTML = `<span>‚è≥</span><span>Creating GIF... ${percent}%</span>`;
            });

            gif.on('error', (error) => {
                clearTimeout(timeoutId);
                console.error('GIF creation error:', error);
                alert('Failed to create GIF. Please try the video option instead.');
                gifBtn.disabled = false;
                gifBtn.innerHTML = originalHTML;
            });

            // Start rendering
            try {
                gif.render();
            } catch (error) {
                clearTimeout(timeoutId);
                console.error('GIF render error:', error);
                alert('Failed to create GIF: ' + error.message);
                gifBtn.disabled = false;
                gifBtn.innerHTML = originalHTML;
            }
        }
    </script>
</body>
</html>
